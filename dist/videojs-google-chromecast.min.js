/**
 * videojs-google-chromecast
 * @version 0.0.3
 * @copyright 2020 mikadoplus <plo@mikadoplus.lu>
 * @license UNLICENSED
 */
/*! @name videojs-google-chromecast @version 0.0.3 @license UNLICENSED */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):(e=e||self).videojsGoogleChromecast=t(e.videojs)}(this,function(g){"use strict";g=g&&Object.prototype.hasOwnProperty.call(g,"default")?g.default:g;var a=function(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t};var h=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e=g.getComponent("Component"),t=g.getComponent("ControlBar"),i=g.getComponent("Button"),o=!1,s=function(s){function e(t,i){var e;void 0===i&&(i={});return["appId","altSource","onStop","onError"].forEach(function(e){i[e]=t.options_.chromecast[e]}),(e=s.call(this,t,i)||this).hide(),e.initializeApi(),e.source=null,e.tryingReconnect=0,t.chromecast=h(e),e.on(t,"loadstart",function(){e.casting&&e.apiInitialized&&e.onSessionSuccess(e.apiSession)}),e.on(t,"dispose",function(){e.casting&&e.apiSession&&e.apiSession.stop(null,null)}),e}a(e,s);var t=e.prototype;return t.buildCSSClass=function(){return"vjs-chromecast-button "+s.prototype.buildCSSClass.call(this,this)},t.initializeApi=function(){var e,t,i,s=window.navigator&&window.navigator.userAgent||"";if((g.browser.IS_CHROME||/CriOS/i.test(s))&&!g.browser.IS_EDGE&&"undefined"!=typeof chrome)return chrome.cast&&chrome.cast.isAvailable?(g.log("Cast APIs are available"),t=this.options_.appId||chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,i=new chrome.cast.SessionRequest(t),e=new chrome.cast.ApiConfig(i,this.sessionJoinedListener.bind(this),this.receiverListener.bind(this)),chrome.cast.initialize(e,this.onInitSuccess.bind(this),this.castError.bind(this))):(g.log("Cast APIs not available"),this.tryingReconnect<10&&(this.setTimeout(this.initializeApi,1e3),++this.tryingReconnect),void g.log("Cast APIs not available. Max reconnect attempt"))},t.castError=function(e){var t={code:e.code,message:e.description};switch(e.code){case chrome.cast.ErrorCode.API_NOT_INITIALIZED:case chrome.cast.ErrorCode.EXTENSION_MISSING:case chrome.cast.ErrorCode.EXTENSION_NOT_COMPATIBLE:case chrome.cast.ErrorCode.INVALID_PARAMETER:case chrome.cast.ErrorCode.LOAD_MEDIA_FAILED:case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:case chrome.cast.ErrorCode.SESSION_ERROR:case chrome.cast.ErrorCode.CHANNEL_ERROR:case chrome.cast.ErrorCode.TIMEOUT:this.addClass("error");break;case chrome.cast.ErrorCode.CANCEL:break;default:this.player_.error(t)}return g.log("Cast Error: "+JSON.stringify(e))},t.onInitSuccess=function(){return o?this.show():this.hide(),this.apiInitialized=!0},t.sessionJoinedListener=function(e){return e.media.length&&(this.apiSession=e,this.onMediaDiscovered(e.media[0])),g.log("Session joined")},t.receiverListener=function(e){if(!this.disposed)return"available"===e?(o=!0,this.show()):(o=!1,this.hide())},t.findSource=function(){return"function"==typeof this.options_.altSource?this.source=this.options_.altSource.call(this):this.source=this.options_.altSource||{src:this.player_.cache_.src,type:this.player_.currentType()}},t.doLaunch=function(){return this.findSource(),g.log("Cast video: "+this.player_.cache_.src),this.apiInitialized?chrome.cast.requestSession(this.onSessionSuccess.bind(this),this.castError.bind(this)):g.log("Session not initialized")},t.onSessionSuccess=function(e){var t,i,s,a,o,r;if(this.apiSession=e,g.log("Session initialized: "+e.sessionId+" source : "+this.source.src+" type : "+this.source.type),(a=new chrome.cast.media.MediaInfo(this.source.src,this.source.type)).metadata=new chrome.cast.media.GenericMediaMetadata,this.options_.playerOptions.chromecast.metadata)for(i in o=this.options_.playerOptions.chromecast.metadata)r=o[i],a.metadata[i]=r;var n=this.player().poster();n&&(t=new chrome.cast.Image(n),a.metadata.images=[t]);var c,d,h,u=this.player().textTracks(),p=this.player().remoteTextTrackEls(),l=[],m=0,f=0;if(u){for(m=0;m<u.length;m++)d=u.tracks_[m],c=p&&p.trackElements_&&p.trackElements_[m],f++,(h=new chrome.cast.media.Track(f,chrome.cast.media.TrackType.TEXT)).trackContentId=c?c.src:"caption_"+d.language,h.subtype=chrome.cast.media.TextTrackType.CAPTIONS,h.name=d.label,h.language=d.language,h.customData=null,l.push(h);a.textTrackStyle=new chrome.cast.media.TextTrackStyle,a.textTrackStyle.foregroundColor="#FFFFFF",a.textTrackStyle.backgroundColor="#00000060",a.textTrackStyle.edgeType=chrome.cast.media.TextTrackEdgeType.DROP_SHADOW,a.textTrackStyle.windowType=chrome.cast.media.TextTrackWindowType.ROUNDED_CORNERS}try{if(u=this.player().audioTracks())for(m=0;m<u.length;m++)d=u.tracks_[m],f++,(h=new chrome.cast.media.Track(f,chrome.cast.media.TrackType.AUDIO)).subtype=null,h.name=d.label,h.language=d.language,h.customData=null,l.push(h)}catch(e){g.log("get player audioTracks fail"+e)}l.length&&(a.tracks=l),(s=new chrome.cast.media.LoadRequest(a)).autoplay=!0,s.currentTime=this.player_.currentTime(),this.apiSession.loadMedia(s,this.onMediaDiscovered.bind(this),this.castError.bind(this)),this.apiSession.addUpdateListener(this.onSessionUpdate.bind(this))},t.onMediaDiscovered=function(e){console.log(this.player_),this.player_.loadTech_("ChromecastTech",{type:"cast",apiMedia:e,apiSession:this.apiSession}),this.casting=!0,this.inactivityTimeout=this.player_.options_.inactivityTimeout,this.player_.options_.inactivityTimeout=0,this.player_.userActive(!0),this.addClass("connected"),this.removeClass("error")},t.onSessionUpdate=function(e){if(this.player_.apiMedia)return e?void 0:this.onStopAppSuccess()},t.stopCasting=function(){return this.apiSession.stop(this.onStopAppSuccess.bind(this),this.castError.bind(this))},t.onStopAppSuccess=function(){this.casting=!1;var e=this.player_.currentTime();return this.removeClass("connected"),this.options_.onStop?this.options_.onStop.call(this,this.source,e):(this.player_.reset(),this.player_.src(this.source),this.player_.paused()||this.player_.one("seeked",function(){return this.player_.play()}),this.player_.currentTime(e)),this.player_.inactivityTimeout=this.inactivityTimeout,this.apiSession=null},t.handleClick=function(){return s.prototype.handleClick.call(this),this.casting?this.stopCasting():this.doLaunch()},e}(i);s.prototype.tryingReconnect=0,s.prototype.inactivityTimeout=2e3,s.prototype.controlText_="Chromecast",t.prototype.options_.children.splice(t.prototype.options_.children.length-2,0,"chromecastButton"),void 0===e.getComponent("ChromecastButton")&&e.registerComponent("ChromecastButton",s);g.getComponent("Component");var r=g.getComponent("Tech"),n=function(d){function e(e,t){var i;void 0===t&&(t={}),(i=d.call(this,e,t)||this).apiMedia=i.options_.source.apiMedia,i.apiSession=i.options_.source.apiSession,i.receiver=i.apiSession.receiver.friendlyName;var s=i.onMediaStatusUpdate.bind(h(i)),a=i.onSessionUpdate.bind(h(i));i.apiMedia.addUpdateListener(s),i.apiSession.addUpdateListener(a),i.on("dispose",function(){i.apiMedia.removeUpdateListener(s),i.apiSession.removeUpdateListener(a),i.onMediaStatusUpdate(),i.onSessionUpdate(!1)});var o=i.textTracks();if(o){var r=i.handleTextTracksChange.bind(h(i));o.addEventListener("change",r),i.on("dispose",function(){o.removeEventListener("change",r)}),i.handleTextTracksChange()}try{if(o=i.audioTracks()){var n=i.handleAudioTracksChange.bind(h(i));o.addEventListener("change",n),i.on("dispose",function(){o.removeEventListener("change",n)})}}catch(e){g.log("get player audioTracks fail"+e)}try{if(o=i.videoTracks()){var c=i.handleVideoTracksChange.bind(h(i));o.addEventListener("change",c),i.on("dispose",function(){o.removeEventListener("change",c)})}}catch(e){g.log("get player videoTracks fail"+e)}return i.update(),i.triggerReady(),i}a(e,d);var t=e.prototype;return t.createEl=function(){return g.dom.createEl("div",{id:this.options_.techId,className:"vjs-tech vjs-tech-chromecast"})},t.update=function(){this.el_.innerHTML='<div class="casting-image" style="background-image: url(\''+this.options_.poster+'\')"></div><div class="casting-overlay"><div class="casting-information"><div class="casting-icon"></div><div class="casting-description"><small>'+this.localize("CASTING TO")+"</small><br>"+this.receiver+"</div></div></div>"},t.onSessionUpdate=function(e){if(this.apiMedia)return e?void 0:this.onStopAppSuccess()},t.onStopAppSuccess=function(){this.stopTrackingCurrentTime(),this.apiMedia=null},t.onMediaStatusUpdate=function(){if(this.apiMedia)switch(this.apiMedia.playerState){case chrome.cast.media.PlayerState.BUFFERING:this.trigger("waiting");break;case chrome.cast.media.PlayerState.IDLE:this.trigger("timeupdate"),this.trigger("ended");break;case chrome.cast.media.PlayerState.PAUSED:this.trigger("pause"),this.paused_=!0;break;case chrome.cast.media.PlayerState.PLAYING:this.trigger("playing"),this.trigger("play"),this.paused_=!1}},t.src=function(e){},t.currentSrc=function(){if(this.apiMedia)return this.apiMedia.media.contentId},t.handleAudioTracksChange=function(){var e=[],t=this.textTracks(),i=this.audioTracks();if(i){for(var s=0;s<i.length;s++){i[s].enabled&&e.push(s+1+t.length)}return this.apiMedia&&e.length?(this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(e),this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this))):void 0}},t.handleVideoTracksChange=function(){},t.handleTextTracksChange=function(){var e=[],t=this.textTracks();if(t){for(var i=0;i<t.length;i++){"showing"===t[i].mode&&e.push(i+1)}return this.apiMedia&&e.length?(this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(e),this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this))):void 0}},t.onTrackSuccess=function(){return g.log("track added")},t.onTrackError=function(e){return g.log("Cast track Error: "+JSON.stringify(e))},t.castError=function(e){return g.log("Cast Error: "+JSON.stringify(e))},t.play=function(){if(this.apiMedia)return this.paused_&&this.apiMedia.play(null,this.mediaCommandSuccessCallback.bind(this,"Playing: "+this.apiMedia.sessionId),this.castError.bind(this)),this.paused_=!1},t.pause=function(){if(this.apiMedia)return this.paused_?void 0:(this.apiMedia.pause(null,this.mediaCommandSuccessCallback.bind(this,"Paused: "+this.apiMedia.sessionId),this.castError.bind(this)),this.paused_=!0)},t.paused=function(){return this.paused_},t.ended=function(){return"FINISHED"===chrome.cast.media.IdleReason},t.currentTime=function(){return this.apiMedia?this.apiMedia.getEstimatedTime():0},t.setCurrentTime=function(e){return this.apiMedia?((t=new chrome.cast.media.SeekRequest).currentTime=e,this.apiMedia.seek(t,this.onSeekSuccess.bind(this,e),this.castError.bind(this))):0;var t},t.onSeekSuccess=function(e){g.log("seek success"+e)},t.volume=function(){return this.volume_},t.duration=function(){return this.apiMedia?this.apiMedia.media.duration||1/0:0},t.controls=function(){return!1},t.setVolume=function(e,t){var i,s;if(void 0===t&&(t=!1),this.apiMedia)return(s=new chrome.cast.Volume).level=e,s.muted=t,this.volume_=s.level,this.muted_=t,(i=new chrome.cast.media.VolumeRequest).volume=s,this.apiMedia.setVolume(i,this.mediaCommandSuccessCallback.bind(this,"Volume changed"),this.castError.bind(this)),this.trigger("volumechange")},t.mediaCommandSuccessCallback=function(e){g.log(e)},t.muted=function(){return this.muted_},t.setMuted=function(e){return this.setVolume(this.volume_,e)},t.supportsFullScreen=function(){return!1},t.resetSrc_=function(e){e()},t.dispose=function(){this.resetSrc_(Function.prototype),d.prototype.dispose.call(this,this)},t.seeking=function(){return!1},t.seekable=function(){return!1},t.playbackRate=function(){return 1},e}(r);n.prototype.paused_=!1,n.prototype.options_={},n.prototype.timerStep=1e3,n.isSupported=function(){return!0},r.withSourceHandlers(n),n.nativeSourceHandler={},n.nativeSourceHandler.canPlayType=function(e){return/^application\/(?:dash\+xml|(x-|vnd\.apple\.)mpegurl)/i.test(e)?"probably":/^video\/(mpd|mp4|webm|m3u8)/i.test(e)?"maybe":""},n.nativeSourceHandler.canHandleSource=function(e){return e.type?n.nativeSourceHandler.canPlayType(e.type):e.src?n.nativeSourceHandler.canPlayType(e.src):""},n.nativeSourceHandler.handleSource=function(e,t){t.src(e.src)},n.nativeSourceHandler.dispose=function(){},n.registerSourceHandler(n.nativeSourceHandler),n.prototype.featuresVolumeControl=!0,n.prototype.featuresPlaybackRate=!1,n.prototype.movingMediaElementInDOM=!1,n.prototype.featuresFullscreenResize=!1,n.prototype.featuresTimeupdateEvents=!1,n.prototype.featuresProgressEvents=!1,n.prototype.featuresNativeTextTracks=!0,n.prototype.featuresNativeAudioTracks=!0,n.prototype.featuresNativeVideoTracks=!1,g.options.chromecast={},void 0===r.getTech("ChromecastTech")&&r.registerTech("ChromecastTech",n);var c=g.getComponent("Component"),d=function(i){function e(e,t){return i.call(this,e,t)||this}return a(e,i),e}(c);d.prototype.options_={},g.options.children.push("chromecast"),g.addLanguage("en",{"CASTING TO":"CASTING TO"}),void 0===c.getComponent("Chromecast")&&c.registerComponent("Chromecast",d);var u=function(e){if(!(!1===e||e&&!1===e.enabled)){this.addChild("Chromecast",e)}},p=g.registerPlugin||g.plugin;return void 0===g.getPlugin("chromecast")&&p("chromecast",u),u.VERSION="0.0.3",u});