/*! @name videojs-google-chromecast @version 0.0.1 @license UNLICENSED */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):(e=e||self).videojsGoogleChromecast=t(e.videojs)}(this,(function(e){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var t=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var i=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t},s=(videojs.registerComponent||videojs.component,videojs.getComponent),a=s("ControlBar"),o=s("Component"),r=s("Button"),n=!1,c=function(e){function s(i,s){var a;return void 0===s&&(s={}),(a=e.call(this,i,s)||this).hide(),a.initializeApi(),void 0===i.options_.chromecast&&(i.options_.chromecast={},i.options_.chromecast.appId=""),s.appId=i.options_.chromecast.appId,i.chromecast=t(a),a.on(i,"loadstart",(function(){a.casting&&a.apiInitialized&&a.onSessionSuccess(a.apiSession)})),a.on(i,"dispose",(function(){a.casting&&a.apiSession&&a.apiSession.stop(null,null)})),a}i(s,e);var a=s.prototype;return a.buildCSSClass=function(){return"vjs-chromecast-button "+e.prototype.buildCSSClass.call(this)},a.initializeApi=function(){var e,t,i,s=window.navigator&&window.navigator.userAgent||"";if((videojs.browser.IS_CHROME||/CriOS/i.test(s))&&!videojs.browser.IS_EDGE&&"undefined"!=typeof chrome)return chrome.cast&&chrome.cast.isAvailable?(videojs.log("Cast APIs are available"),t=this.options_.appId||chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,i=new chrome.cast.SessionRequest(t),e=new chrome.cast.ApiConfig(i,this.sessionJoinedListener.bind(this),this.receiverListener.bind(this)),chrome.cast.initialize(e,this.onInitSuccess.bind(this),this.castError.bind(this))):(videojs.log("Cast APIs not available"),this.tryingReconnect<10&&(this.setTimeout(this.initializeApi,1e3),++this.tryingReconnect),void videojs.log("Cast APIs not available. Max reconnect attempt"))},a.castError=function(e){var t={code:e.code,message:e.description};switch(e.code){case chrome.cast.ErrorCode.API_NOT_INITIALIZED:case chrome.cast.ErrorCode.EXTENSION_MISSING:case chrome.cast.ErrorCode.EXTENSION_NOT_COMPATIBLE:case chrome.cast.ErrorCode.INVALID_PARAMETER:case chrome.cast.ErrorCode.LOAD_MEDIA_FAILED:case chrome.cast.ErrorCode.RECEIVER_UNAVAILABLE:case chrome.cast.ErrorCode.SESSION_ERROR:case chrome.cast.ErrorCode.CHANNEL_ERROR:case chrome.cast.ErrorCode.TIMEOUT:this.addClass("error");break;case chrome.cast.ErrorCode.CANCEL:break;default:this.player_.error(t)}return videojs.log("Cast Error: "+JSON.stringify(e))},a.onInitSuccess=function(){return n?this.show():this.hide(),this.apiInitialized=!0},a.sessionJoinedListener=function(e){return e.media.length&&(this.apiSession=e,this.onMediaDiscovered(e.media[0])),console.log("Session joined")},a.receiverListener=function(e){return"available"===e?(n=!0,this.show()):(n=!1,this.hide())},a.doLaunch=function(){return videojs.log("Cast video: "+this.player_.cache_.src),this.apiInitialized?chrome.cast.requestSession(this.onSessionSuccess.bind(this),this.castError.bind(this)):videojs.log("Session not initialized")},a.onSessionSuccess=function(e){var t,i,s,a,o,r;this.apiSession=e;var n=this.player_.cache_.src,c=this.player_.currentType();if(videojs.log("Session initialized: "+e.sessionId+" source : "+n+" type : "+c),(a=new chrome.cast.media.MediaInfo(n,c)).metadata=new chrome.cast.media.GenericMediaMetadata,void 0===this.options_.playerOptions.chromecast?(this.options_.playerOptions.chromecast={},this.options_.playerOptions.chromecast.metadata=""):void 0===this.options_.playerOptions.chromecast.metadata&&(this.options_.playerOptions.chromecast.metadata=""),""!==this.options_.playerOptions.chromecast.metadata)for(i in o=this.options_.playerOptions.chromecast.metadata)r=o[i],a.metadata[i]=r;var d=this.player().poster();d&&(t=new chrome.cast.Image(d),a.metadata.images=[t]);var h,p,u,l=this.player().textTracks(),m=this.player().remoteTextTrackEls(),v=[],g=0,f=0;if(l){for(g=0;g<l.length;g++)p=l.tracks_[g],h=m&&m.trackElements_&&m.trackElements_[g],f++,(u=new chrome.cast.media.Track(f,chrome.cast.media.TrackType.TEXT)).trackContentId=h?h.src:"caption_"+p.language,u.subtype=chrome.cast.media.TextTrackType.CAPTIONS,u.name=p.label,u.language=p.language,u.customData=null,v.push(u);a.textTrackStyle=new chrome.cast.media.TextTrackStyle,a.textTrackStyle.foregroundColor="#FFFFFF",a.textTrackStyle.backgroundColor="#00000060",a.textTrackStyle.edgeType=chrome.cast.media.TextTrackEdgeType.DROP_SHADOW,a.textTrackStyle.windowType=chrome.cast.media.TextTrackWindowType.ROUNDED_CORNERS}try{if(l=this.player().audioTracks())for(g=0;g<l.length;g++)p=l.tracks_[g],f++,(u=new chrome.cast.media.Track(f,chrome.cast.media.TrackType.AUDIO)).subtype=null,u.name=p.label,u.language=p.language,u.customData=null,v.push(u)}catch(e){videojs.log("get player audioTracks fail"+e)}v.length&&(a.tracks=v),(s=new chrome.cast.media.LoadRequest(a)).autoplay=!0,s.currentTime=this.player_.currentTime(),this.apiSession.loadMedia(s,this.onMediaDiscovered.bind(this),this.castError.bind(this)),this.apiSession.addUpdateListener(this.onSessionUpdate.bind(this))},a.onMediaDiscovered=function(e){this.player_.loadTech_("chromecast",{type:"cast",apiMedia:e,apiSession:this.apiSession}),this.casting=!0,this.inactivityTimeout=this.player_.options_.inactivityTimeout,this.player_.options_.inactivityTimeout=0,this.player_.userActive(!0),this.addClass("connected"),this.removeClass("error")},a.onSessionUpdate=function(e){if(this.player_.apiMedia)return e?void 0:this.onStopAppSuccess()},a.stopCasting=function(){return this.apiSession.stop(this.onStopAppSuccess.bind(this),this.castError.bind(this))},a.onStopAppSuccess=function(){this.casting=!1;var e=this.player_.currentTime();return this.removeClass("connected"),this.player_.src(this.player_.options_.sources),this.player_.paused()||this.player_.one("seeked",(function(){return this.player_.play()})),this.player_.currentTime(e),this.player_.options_.inactivityTimeout=this.inactivityTimeout,this.apiSession=null},a.handleClick=function(){return e.prototype.handleClick.call(this),this.casting?this.stopCasting():this.doLaunch()},s}(r);c.prototype.tryingReconnect=0,c.prototype.inactivityTimeout=2e3,c.prototype.controlText_="Chromecast",a.prototype.options_.children.splice(a.prototype.options_.children.length-2,0,"chromecastButton"),void 0===s("ChromecastButton")&&o.registerComponent("ChromecastButton",c);var d=videojs.getTech,h=videojs.registerTech,p=videojs.extend(d("Tech"),{constructor:function(e,t){var i=this;d("Tech").apply(this,arguments),this.apiMedia=this.options_.source.apiMedia,this.apiSession=this.options_.source.apiSession,this.receiver=this.apiSession.receiver.friendlyName;var s=this.onMediaStatusUpdate.bind(this),a=this.onSessionUpdate.bind(this);this.apiMedia.addUpdateListener(s),this.apiSession.addUpdateListener(a),this.on("dispose",(function(){i.apiMedia.removeUpdateListener(s),i.apiSession.removeUpdateListener(a),i.onMediaStatusUpdate(),i.onSessionUpdate(!1)}));var o=this.textTracks();if(o){var r=this.handleTextTracksChange.bind(this);o.addEventListener("change",r),this.on("dispose",(function(){o.removeEventListener("change",r)})),this.handleTextTracksChange()}try{if(o=this.audioTracks()){var n=this.handleAudioTracksChange.bind(this);o.addEventListener("change",n),this.on("dispose",(function(){o.removeEventListener("change",n)}))}}catch(e){videojs.log("get player audioTracks fail"+e)}try{if(o=this.videoTracks()){var c=this.handleVideoTracksChange.bind(this);o.addEventListener("change",c),this.on("dispose",(function(){o.removeEventListener("change",c)}))}}catch(e){videojs.log("get player videoTracks fail"+e)}this.update(),this.triggerReady()},createEl:function(){return videojs.dom.createEl("div",{id:this.options_.techId,className:"vjs-tech vjs-tech-chromecast"})},update:function(){this.el_.innerHTML='<div class="casting-image" style="background-image: url(\''+this.options_.poster+'\')"></div><div class="casting-overlay"><div class="casting-information"><div class="casting-icon"></div><div class="casting-description"><small>'+this.localize("CASTING TO")+"</small><br>"+this.receiver+"</div></div></div>"},onSessionUpdate:function(e){if(this.apiMedia)return e?void 0:this.onStopAppSuccess()},onStopAppSuccess:function(){this.stopTrackingCurrentTime(),this.apiMedia=null},onMediaStatusUpdate:function(){if(this.apiMedia)switch(this.apiMedia.playerState){case chrome.cast.media.PlayerState.BUFFERING:this.trigger("waiting");break;case chrome.cast.media.PlayerState.IDLE:this.trigger("timeupdate"),this.trigger("ended");break;case chrome.cast.media.PlayerState.PAUSED:this.trigger("pause"),this.paused_=!0;break;case chrome.cast.media.PlayerState.PLAYING:this.trigger("playing"),this.trigger("play"),this.paused_=!1}},src:function(e){},currentSrc:function(){if(this.apiMedia)return this.apiMedia.media.contentId},handleAudioTracksChange:function(){var e=[],t=this.textTracks(),i=this.audioTracks();if(i){for(var s=0;s<i.length;s++){i[s].enabled&&e.push(s+1+t.length)}return this.apiMedia&&e.length?(this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(e),this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this))):void 0}},handleVideoTracksChange:function(){},handleTextTracksChange:function(){var e=[],t=this.textTracks();if(t){for(var i=0;i<t.length;i++){"showing"===t[i].mode&&e.push(i+1)}return this.apiMedia&&e.length?(this.tracksInfoRequest=new chrome.cast.media.EditTracksInfoRequest(e),this.apiMedia.editTracksInfo(this.tracksInfoRequest,this.onTrackSuccess.bind(this),this.onTrackError.bind(this))):void 0}},onTrackSuccess:function(){return videojs.log("track added")},onTrackError:function(e){return videojs.log("Cast track Error: "+JSON.stringify(e))},castError:function(e){return videojs.log("Cast Error: "+JSON.stringify(e))},play:function(){if(this.apiMedia)return this.paused_&&this.apiMedia.play(null,this.mediaCommandSuccessCallback.bind(this,"Playing: "+this.apiMedia.sessionId),this.castError.bind(this)),this.paused_=!1},pause:function(){if(this.apiMedia)return this.paused_?void 0:(this.apiMedia.pause(null,this.mediaCommandSuccessCallback.bind(this,"Paused: "+this.apiMedia.sessionId),this.castError.bind(this)),this.paused_=!0)},paused:function(){return this.paused_},ended:function(){return"FINISHED"===chrome.cast.media.IdleReason},currentTime:function(){return this.apiMedia?this.apiMedia.getEstimatedTime():0},setCurrentTime:function(e){return this.apiMedia?((t=new chrome.cast.media.SeekRequest).currentTime=e,this.apiMedia.seek(t,this.onSeekSuccess.bind(this,e),this.castError.bind(this))):0;var t},onSeekSuccess:function(e){videojs.log("seek success"+e)},volume:function(){return this.volume_},duration:function(){return this.apiMedia?this.apiMedia.media.duration||1/0:0},controls:function(){return!1},setVolume:function(e,t){var i,s;if(void 0===t&&(t=!1),this.apiMedia)return(s=new chrome.cast.Volume).level=e,s.muted=t,this.volume_=s.level,this.muted_=t,(i=new chrome.cast.media.VolumeRequest).volume=s,this.apiMedia.setVolume(i,this.mediaCommandSuccessCallback.bind(this,"Volume changed"),this.castError.bind(this)),this.trigger("volumechange")},mediaCommandSuccessCallback:function(e){videojs.log(e)},muted:function(){return this.muted_},setMuted:function(e){return this.setVolume(this.volume_,e)},supportsFullScreen:function(){return!1},resetSrc_:function(e){e()},dispose:function(){this.resetSrc_(Function.prototype),d("Tech").dispose(this)},seeking:function(){return!1},seekable:function(){return!1},playbackRate:function(){return 1}});p.prototype.paused_=!1,p.prototype.timerStep=1e3,p.isSupported=function(){return!0},d("Tech").withSourceHandlers(p),p.nativeSourceHandler={},p.nativeSourceHandler.canPlayType=function(e){return/^application\/(?:dash\+xml|(x-|vnd\.apple\.)mpegurl)/i.test(e)?"probably":/^video\/(mpd|mp4|webm|m3u8)/i.test(e)?"maybe":""},p.nativeSourceHandler.canHandleSource=function(e){return e.type?p.nativeSourceHandler.canPlayType(e.type):e.src?p.nativeSourceHandler.canPlayType(e.src):""},p.nativeSourceHandler.handleSource=function(e,t){t.src(e.src)},p.nativeSourceHandler.dispose=function(){},p.registerSourceHandler(p.nativeSourceHandler),p.prototype.featuresVolumeControl=!0,p.prototype.featuresPlaybackRate=!1,p.prototype.movingMediaElementInDOM=!1,p.prototype.featuresFullscreenResize=!1,p.prototype.featuresTimeupdateEvents=!1,p.prototype.featuresProgressEvents=!1,p.prototype.featuresNativeTextTracks=!0,p.prototype.featuresNativeAudioTracks=!0,p.prototype.featuresNativeVideoTracks=!1,void 0===d("ChromecastTech")&&h("chromecast",p);var u=videojs.registerComponent||videojs.component,l=videojs.getComponent,m=videojs.extend(l("Component"),{constructor:function(e,t){l("Component").apply(this,arguments)}});m.prototype.options_={},videojs.options.children.push("chromecast"),videojs.addLanguage("en",{"CASTING TO":"CASTING TO"}),void 0===l("GoogleChromecast")&&u("GoogleChromecast",m);var v=e.registerPlugin||e.plugin,g=e.getPlugin||e.plugin,f=(e.registerPlugin,e.getComponent,function(e){});return void 0===g("chromecast")&&v("chromecast",f),f.VERSION="0.0.1",f}));
